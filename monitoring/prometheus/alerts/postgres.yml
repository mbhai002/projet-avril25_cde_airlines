groups:
- name: postgres-alerts
  rules:

  - alert: PostgresDown
    expr: pg_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "PostgreSQL indisponible"
      description: "PostgreSQL ne répond plus depuis 1 minute"

  - alert: PostgresTooManyConnections
    expr: pg_stat_activity_count > pg_settings_max_connections * 0.8
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Connexions PostgreSQL élevées"
      description: "Plus de 80% des connexions utilisées"

  - alert: PostgresReplicationLag
    expr: pg_replication_lag_seconds > 60
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Lag de réplication PostgreSQL"
      description: "Lag > 60 secondes"

  - alert: PostgresDeadlocks
    expr: increase(pg_stat_database_deadlocks[5m]) > 0
    labels:
      severity: warning
    annotations:
      summary: "Deadlock PostgreSQL détecté"

  - alert: PostgresDiskAlmostFull
    expr: (pg_database_size_bytes / node_filesystem_size_bytes{mountpoint="/"} ) > 0.85
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Disque PostgreSQL presque plein"

