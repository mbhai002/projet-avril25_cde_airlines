name: dbt CI for PostgreSQL
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install dbt-postgres
        run: pip install dbt-postgres
      - name: Configure profile
        run: |
          mkdir -p ~/.dbt
          cat <<EOF > ~/.dbt/profiles.yml
          airlines_profile:
            target: ci
            outputs:
              ci:
                type: postgres
                host: ${{ secrets.PGHOST }}
                user: ${{ secrets.PGUSER }}
                password: ${{ secrets.PGPASSWORD }}
                port: ${{ secrets.PGPORT }}
                dbname: ${{ secrets.PGDATABASE }}
                schema: dwh
                threads: 4
          EOF
      - name: dbt seed
        run: dbt seed --profiles-dir ~/.dbt
      - name: dbt run
        run: dbt run --profiles-dir ~/.dbt
      - name: dbt test
        run: dbt test --profiles-dir ~/.dbt
